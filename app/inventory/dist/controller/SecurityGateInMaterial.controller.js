sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel"],function(e,t,i,n){"use strict";let s=0;return e.extend("inventory.controller.SecurityGateInMaterial",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteGateMaterial").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(){try{this.resetTableControls();const e=JSON.parse(sessionStorage.getItem("materialData"));const t=e?e.reqNo:null;console.log("status hai",e.reqStatus);if(e.reqStatus==="Received at warehouse"){this.layoutEditOnStatus()}else{let e=this.getView().byId("materialDetailsLayout2");let t=this.getView().byId("materialDetailsLayout");e.setVisible(false);t.setVisible(true)}let a=this.getOwnerComponent().getModel();let n=a.bindList("/rqMaterial",undefined,undefined,undefined,{$expand:"SubcomponentList"});let s=await n.requestContexts(0,Infinity);let o=s.map(e=>e.getObject());let r=o.filter(e=>e.reqNo===t);console.log("Bid details data:",r);let l=new i(r);this.getView().setModel(l,"materialData");console.log("model data is",this.getView().getModel("materialData").getData());let d=this.byId("materialTable");d.attachEventOnce("updateFinished",this.resetTableControls.bind(this))}catch(e){}},_onGetValue:function(){let e=this.getValueData.filter(e=>{e.Strap===this.newValue&&e.Lgort==="LOC02"}).map(e=>{let t=e.matnr===this.newMatnr;return t.indexOf(a)});let t=e.concat(this.extractValue);t.getAllItems(this.getAllDataFetched(t));let i=this.byId("materialListTable");let n=i.getBindingContext("materialDataModel");n.getObject();let s=n.getBinding("materialModel");s.getObject();s.getData().newValue},layoutEditOnStatus:function(){let e=this.getView().byId("materialDetailsLayout2");let t=this.getView().byId("materialDetailsLayout");e.setVisible(true);t.setVisible(false);if(!s){s=1}},resetTableControls:function(){let e=this.byId("materialTable");e.getItems().forEach(function(e){let t=e.getCells();let a=t[5];if(a instanceof sap.m.Select){a.setSelectedKey("")}let i=t[4];if(i instanceof sap.m.Input){i.setEditable(false)}let n=t[6];if(n instanceof sap.m.Input){n.setValue("")}})},nMaterialRowSelect:async function(e){debugger;const a=this.getView();const i=JSON.parse(sessionStorage.getItem("materialData"));const n=i.reqStatus;let s=e.getSource().getParent().getBindingContext("materialData");let o=s.getObject();let r=o.SubcomponentList||[];if(!this.expandCheckinDataFragment){t.load({id:a.getId(),name:"inventory.fragments.GateInSubMaterial",controller:this}).then(e=>{this.expandCheckinDataFragment=e;a.addDependent(this.expandCheckinDataFragment);let i=new sap.ui.model.json.JSONModel(r);this.expandCheckinDataFragment.setModel(i,"subMaterialData");if(n==="Received at warehouse"){let e=t.byId(this.getView().getId(),"expandSubTable2");e.setVisible(true);let a=t.byId(this.getView().getId(),"expandSubTable");a.setVisible(false)}this.expandCheckinDataFragment.open()}).catch(e=>{console.error("Failed to load fragment:",e)})}else{let e=new sap.ui.model.json.JSONModel(r);this.expandCheckinDataFragment.setModel(e,"subMaterialData");let a=t.byId(this.getView().getId(),"expandSubTable2");a.setVisible(false);let i=t.byId(this.getView().getId(),"expandSubTable");i.setVisible(true);this.expandCheckinDataFragment.open()}},onMaterialRowSelect:async function(e){const a=this.getView();const i=JSON.parse(sessionStorage.getItem("materialData"));const n=i.reqStatus;let s=e.getSource().getParent().getBindingContext("materialData");let o=s.getObject();let r=o.MatStatus;let l=o.SubcomponentList||[];if(!this.expandCheckinDataFragment){try{this.expandCheckinDataFragment=await t.load({id:a.getId(),name:"inventory.fragments.GateInSubMaterial",controller:this});a.addDependent(this.expandCheckinDataFragment)}catch(e){console.error("Failed to load fragment:",e);return}}let d=new sap.ui.model.json.JSONModel(l);this.expandCheckinDataFragment.setModel(d,"subMaterialData");let u=t.byId(a.getId(),"expandSubTable");let g=t.byId(a.getId(),"expandSubTable2");let c=t.byId(a.getId(),"_IDGenButton1");if(!r||r==="Full Received"||r==="Not Received"||n==="Received at warehouse"){u.setVisible(false);g.setVisible(true);c.setVisible(false)}else{u.setVisible(true);g.setVisible(false);c.setVisible(true)}this.expandCheckinDataFragment.open()},_onStatusTypeChange:function(e){let t=e.getParameter("selectedItem");let a=t.getKey();var i=e.getSource();var n=i.getSelectedItem().getText();let s=e.getSource().getBindingContext("materialData");s.setProperty("MatStatus",a);console.log("selected item",n);let o=i.getParent();let r=o.getCells()[4];if(n==="Partial"){if(r instanceof sap.m.Input){r.setEditable(true)}}else{if(r instanceof sap.m.Input){r.setEditable(false)}}},_onCancelCheckinSubFragment:function(){this.expandCheckinDataFragment.close()},_onMaterialSubmit:async function(){let e=this.byId("materialTable");let t=e.getItems();let a=[];t.forEach(function(e){let t=e.getBindingContext("materialData");if(t){let e=t.getProperty("Status");let i=parseInt(t.getProperty("Quantity"))||0;let n=t.getProperty("SubcomponentList");if(e==="Not Received"){i=0;n=n.map(e=>({...e,Quantity:parseInt(0)}))}else{n=n.map(e=>({...e,Quantity:parseInt(e.Quantity)||0}))}let s={reqNo:t.getProperty("reqNo"),MaterialCode:t.getProperty("MaterialCode"),Category:t.getProperty("Category"),Description:t.getProperty("Description"),Quantity:i,Remarks:t.getProperty("Remarks"),Status:e,SubcomponentList:n};a.push(s)}});console.log("updated data of all",a);await this._submitData(a)},onMaterialSubmit:async function(){debugger;let e=this.byId("materialTable");let t=e.getItems();let a=[];t.forEach(function(e){let t=e.getBindingContext("materialData");let i=t.getProperty("Status");let n=t.getProperty("Quantity");let s=t.getProperty("SubcomponentList");if(i==="Not Received"){n=0;s=s.map(e=>({...e,Quantity:0}))}let o={reqNo:t.getProperty("reqNo"),MaterialCode:t.getProperty("MaterialCode"),Category:t.getProperty("Category"),Description:t.getProperty("Description"),Quantity:i==="Not Received"?0:parseInt(n),Remarks:t.getProperty("Remarks"),Status:t.getProperty("Status"),SubcomponentList:s};a.push(o)});console.log("updated data of all",a);this._submitData(a)},_submitData:async function(e){let t=this.getView().getModel();const a=JSON.parse(sessionStorage.getItem("materialData"));const i=a?a.reqNo:null;let n=t.bindList("/serviceRequest");let s=[new sap.ui.model.Filter("reqNo",sap.ui.model.FilterOperator.EQ,i)];try{let a=await n.filter(s).requestContexts();if(a.length>0){let i=a[0];i.setProperty("reqStatus","Received at warehouse");let n=i.getModel().bindList("Materials",i);let s=await n.requestContexts();for(let t of e){let e=s.find(e=>e.getProperty("MaterialCode")===t.MaterialCode);if(e){e.setProperty("Category",t.Category);e.setProperty("Description",t.Description);e.setProperty("Quantity",t.Quantity);e.setProperty("MatRemarks",t.Remarks);e.setProperty("MatStatus",t.Status);if(t.SubcomponentList&&t.SubcomponentList.length>0){let a=e.getModel().bindList("SubcomponentList",e);let i=await a.requestContexts();for(let e of t.SubcomponentList){let t=i.find(t=>t.getProperty("MaterialCode")===e.MaterialCode);if(t){t.setProperty("Category",e.Category);t.setProperty("Description",e.Description);t.setProperty("Quantity",e.Quantity)}else{console.error("No sub-material found for MaterialCode: "+e.MaterialCode)}}}}else{console.error("No material found for MaterialCode: "+t.MaterialCode)}}if(t.hasPendingChanges()){await t.submitBatch("updateGroup");sap.m.MessageToast.show("All materials and sub-materials updated successfully.");setTimeout(()=>{const e=this.getOwnerComponent().getRouter();e.navTo("RouteWarehouseMain")},1e3)}else{console.log("No pending changes detected")}}else{console.error("Service request not found for reqNo: "+i)}}catch(e){console.error("Error updating materials and sub-materials:",e);sap.m.MessageToast.show("Error updating materials: "+e.message)}}})});
//# sourceMappingURL=SecurityGateInMaterial.controller.js.map