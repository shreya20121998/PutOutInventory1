sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/m/MessageToast"],function(e,t,a,o,i){"use strict";let s=0;let n=0;return e.extend("inventory.controller.InspectionTable",{onInit:function(){const e=this.getOwnerComponent().getRouter();e.getRoute("RouteInspectionTable").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(){try{this.resetTableControls();const e=JSON.parse(sessionStorage.getItem("materialData"));let t=this.getOwnerComponent().getModel();let o=t.bindList("/rqMaterial",undefined,undefined,undefined,{$expand:"SubcomponentList"});let i=await o.requestContexts(0,Infinity);let s=i.map(e=>e.getObject());let n=s.filter(t=>t.reqNo===e);let r=new a(n);this.getView().setModel(r,"materialData");let l=this.byId("materialTable");l.attachEventOnce("updateFinished",this.resetTableControls.bind(this))}catch(e){console.error("Error loading material data:",e)}},resetTableControls:function(){let e=this.byId("materialTable");e.getItems().forEach(function(e){let t=e.getCells();let a=t[5];if(a instanceof sap.m.Input){if(!a.data("originalValue")){a.data("originalValue",a.getValue())}}})},onMaterialRowSelect:async function(e){const a=this.getView();let o=e.getSource().getParent().getBindingContext("materialData");let i=o.getObject();let s=i.MaterialCode;const n=JSON.parse(sessionStorage.getItem("materialData"));let r=this.getOwnerComponent().getModel();let l=r.bindList("/rqSubMaterial",undefined,undefined,undefined,undefined);let d=await l.requestContexts(0,Infinity);let g=d.map(e=>e.getObject());let u=g.filter(e=>e.reqNo===n&&e.Parent_MaterialCode===s);console.log("Bid details data:",u);let c=u||[];if(!this.expandCheckinDataFragment){t.load({id:a.getId(),name:"inventory.fragments.subComponent",controller:this}).then(e=>{this.expandCheckinDataFragment=e;a.addDependent(this.expandCheckinDataFragment);let t=new sap.ui.model.json.JSONModel(c);this.expandCheckinDataFragment.setModel(t,"subMaterialData");this.expandCheckinDataFragment.open()}).catch(e=>{console.error("Failed to load fragment:",e)})}else{let e=new sap.ui.model.json.JSONModel(c);this.expandCheckinDataFragment.setModel(e,"subMaterialData");this.expandCheckinDataFragment.open()}},_onStatusTypeChange:function(e){var t=e.getSource();var a=t.getSelectedItem().getText();console.log("selected item",a)},_onObjectMatched:async function(){try{this.resetTableControls();const e=JSON.parse(sessionStorage.getItem("materialData"));console.log("Request Number:",e);let t=this.getOwnerComponent().getModel();let o=t.bindList("/rqMaterial",undefined,undefined,undefined,undefined);let i=await o.requestContexts(0,Infinity);let s=i.map(e=>e.getObject());let n=s.filter(t=>t.reqNo===e);console.log("Filtered Data:",n);let r=new a(n);this.getView().setModel(r,"materialData");let l=this.byId("materialTable");l.attachEventOnce("updateFinished",this.resetTableControls.bind(this))}catch(e){console.error("Error loading material data:",e);sap.m.MessageToast.show("Error loading material data: "+e.message)}},_onCancelCheckinSubFragment:function(){this.expandCheckinDataFragment.close()},onSubmit:async function(){let e=this.byId("materialTable");let t=e.getBinding("items").getCurrentContexts();t.forEach(e=>{let t=e.getObject();let a={reqNo:t.reqNo,MaterialCode:t.MaterialCode,MatStatus:t.Status,Quantity:parseInt(t.Quantity),MatRemarks:t.Remarks,f_MaterialCode:t.f_MaterialCode};console.log("payload",a);let o=this.getOwnerComponent().getModel();let i=o.bindList("/splitMaterilalTable");i.create(a);sap.m.MessageToast.show("Successfully Submitted")});let a=this.getView().getModel();const o=JSON.parse(sessionStorage.getItem("materialData"));const i=o?o:null;let s=a.bindList("/serviceRequest");let n=[new sap.ui.model.Filter("reqNo",sap.ui.model.FilterOperator.EQ,i)];let r=await s.filter(n).requestContexts();if(r.length>0){let e=r[0];e.setProperty("reqStatus","Inspection Completed");sap.m.MessageToast.show("All materials and sub-materials Inspected successfully.")}},_onMaterialSubmit:async function(){let e=this.byId("materialTable");let t=e.getItems();let a=[];for(let e=0;e<t.length;e++){let i=t[e];let s=i.getBindingContext("materialData");if(s){let e=s.getProperty("Status");let t=parseInt(s.getProperty("Quantity"))||0;let i=s.getProperty("SubcomponentList");if(e===""){o.error("Please fill Status");return;i=i.map(e=>({...e}))}else{i=i.map(e=>({...e,Quantity:parseInt(e.Quantity)||0}))}let n={reqNo:s.getProperty("reqNo"),MaterialCode:s.getProperty("MaterialCode"),Category:s.getProperty("Category"),Description:s.getProperty("Description"),Quantity:t,MatRemarks:s.getProperty("Remarks"),MatStatus:e,SubcomponentList:i};a.push(n)}}console.log("updated data of all",a);await this._submitData(a)},_submitData:async function(e){let t=this.getView().getModel();const a=JSON.parse(sessionStorage.getItem("materialData"));const o=a?a.reqNo:null;let i=t.bindList("/serviceRequest");let s=[new sap.ui.model.Filter("reqNo",sap.ui.model.FilterOperator.EQ,o)];try{let a=await i.filter(s).requestContexts();if(a.length>0){let o=a[0];o.setProperty("reqStatus","Inspection Completed");let i=o.getModel().bindList("Materials",o);let s=await i.requestContexts();for(let t of e){let e=s.find(e=>e.getProperty("MaterialCode")===t.MaterialCode);if(e){e.setProperty("Category",t.Category);e.setProperty("Description",t.Description);e.setProperty("Quantity",t.Quantity);e.setProperty("MatRemarks",t.Remarks);e.setProperty("MatStatus",t.Status);e.setProperty("f_MaterialCode",t.f_MaterialCode);if(t.SubcomponentList&&t.SubcomponentList.length>0){let a=e.getModel().bindList("SubcomponentList",e);let o=await a.requestContexts();for(let e of t.SubcomponentList){let a=o.find(t=>t.getProperty("MaterialCode")===e.MaterialCode);if(a){a.setProperty("Category",e.Category);a.setProperty("Description",e.Description);a.setProperty("Quantity",e.Quantity);a.setProperty("MatStatus",t.Status);a.setProperty("MatRemarks",t.Remarks)}else{console.error("No sub-material found for MaterialCode: "+e.MaterialCode)}}}}else{console.error("No material found for MaterialCode: "+t.MaterialCode)}}if(t.hasPendingChanges()){await t.submitBatch("updateGroup");sap.m.MessageToast.show("All materials and sub-materials Inspected successfully.")}else{console.log("No pending changes detected")}}else{console.error("Service request not found for reqNo: "+o)}}catch(e){console.error("Error updating materials and sub-materials:",e);sap.m.MessageToast.show("Error updating materials: "+e.message)}},showCategoryValueHelp:function(e){console.log("BUTTON");this.oSource=e.getSource();this.oRowContext=this.byId("materialTable").getSelectedItem().getBindingContext("materialData");this.oRowData=this.oRowContext.getObject();if(!this._CategoryDialog){this._CategoryDialog=sap.ui.xmlfragment("inventory.fragments.CategoryValueHelp",this);this.getView().addDependent(this._CategoryDialog)}this._CategoryDialog.open();if(this._CategoryDialog){this._CategoryDialog.getBinding("items").filter([])}},onCategoryValueHelpClose:function(e){let t=e.getParameter("selectedItem");this.obj=t.getBindingContext().getObject();let a=this.oSource;this.prevValue=a.getProperty("value");this.oSource.setValue(this.obj.Type);if(!t){if(that._CategoryDialog){that._CategoryDialog.destroy();that._CategoryDialog=null}return}},onPressChangeCategory:function(){console.log("Change category button pressed");var e=this.byId("materialTable");var t=e.getSelectedItem();if(t){var a=t.getCells();if(a[1].getValue()!==a[2].getValue()){i.show("New code already Generated");return}var o=a[2];var s=a[3];if(o instanceof sap.m.Input){o.setEditable(true)}if(s instanceof sap.m.Input){s.setEditable(true)}this.byId("changeCategoryBtn").setVisible(false);this.byId("newCodeGenerationBtn").setVisible(true)}else{sap.m.MessageToast.show("Please select a row to change category.")}},onGenerateNewCode:async function(e){const t=JSON.parse(sessionStorage.getItem("materialData"));let a=this.getOwnerComponent().getModel();let i=a.bindList("/rqSubMaterial",undefined,undefined,undefined,undefined);let s=a.bindList("/Material");let n=await i.requestContexts(0,Infinity);let r=n.map(e=>e.getObject());let l=this.byId("materialTable").getSelectedItem();if(!this.obj){o.warning("Please Change Category");return}let d=r.filter(e=>e.reqNo===t&&e.Parent_MaterialCode===this.oRowData.MaterialCode);let g=d||[];console.log(g);let u=[];g.forEach(e=>{let t={Description:e.Description,MaterialCode:e.MaterialCode,Category:e.Category,Quantity:e.Quantity,Parent_MaterialCode:""};u.push(t)});if(this.oRowData.MaterialCode!==this.oRowData.f_MaterialCode){sap.m.MessageToast.show("New Code already Generated");return}if(this.prevValue!==this.obj.Type){this.oSource.setValue(this.obj.Type);console.log("fkjdsfj",this.prevValue,this.oRowData);let e={Description:this.oRowData.Description,Category:this.oRowData.Category,MaterialCode:"",Status:"Active",Quantity:parseInt(this.oRowData.Quantity),SubcomponentList:u};s.create(e,true);s.attachCreateCompleted(e=>{let t=e.getParameters();let a=t.context;if(t.success){let e=a.getObject();console.log(e);o.success(`New code ${e.MaterialCode} generated Successfully`);this.oRowData.f_MaterialCode=e.MaterialCode;g.forEach(e=>e.Parent_MaterialCode=this.oRowData.f_MaterialCode);console.log("sub materials and material ",g);this.getView().getModel("materialData").refresh();if(l){l.getCells()[2].setEditable(false);l.getCells()[3].setEditable(false);this.byId("materialTable").removeSelections()}this.byId("changeCategoryBtn").setVisible(true);this.byId("newCodeGenerationBtn").setVisible(false)}else{reject(t)}})}else{o.error("Please Change Category")}},onsavesubcomponent:function(){let e=this.byId("expandSubTable");let t=e.getBinding("items").getCurrentContexts();t.forEach(e=>{let t=e.getObject();let a={reqNo:t.reqNo,MaterialCode:t.MaterialCode,Parent_MaterialCode:t.Parent_MaterialCode,MatStatus:t.MatStatus,Quantity:parseInt(t.Quantity),MatRemarks:t.MatRemarks};console.log("payload",a);let o=this.getOwnerComponent().getModel();let i=o.bindList("/splitSubMaterialTable");i.create(a);sap.m.MessageToast.show("Successfully Submited")})},quantityChange:function(e){let t=e.getSource();let a=parseFloat(t.getValue());if(n==0){n=parseFloat(t.data("originalValue"))}if(!isNaN(n)&&!isNaN(a)){let e=n-a;console.log("Original Quantity:",n);console.log("New Quantity:",a);console.log("Difference in Quantity:",e);if(e<0){sap.m.MessageToast.show("Original quantity exceeded. No row added.");console.warn("Original quantity exceeded. New quantity cannot be less than the original.")}else{n=e;let a=t.getBindingContext("materialData");let o=a.getObject();let i=Object.assign({},o);i.Quantity=e;let s=this.getView().getModel("materialData");let r=s.getData();r.push(i);s.setData(r);sap.m.MessageToast.show("Row duplicated successfully with Quantity difference.")}}else{console.log("Invalid quantity values")}}})});
//# sourceMappingURL=InspectionTable.controller.js.map